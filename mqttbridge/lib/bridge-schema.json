{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://example.com/mqttbridge.schema.json",
  "title": "MQTT Bridge Configuration",
  "type": "object",
  "required": [
    "bridges"
  ],
  "additionalProperties": false,
  "properties": {
    "bridges": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/$defs/bridge"
      }
    }
  },
  "$defs": {
    "bridge": {
      "type": "object",
      "required": [
        "name",
        "brokers"
      ],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string"
        },
        "brokers": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/broker"
          }
        }
      }
    },
    "broker": {
      "type": "object",
      "required": [
        "network"
      ],
      "additionalProperties": false,
      "properties": {
        "session_store": {
          "type": "string",
          "default": ""
        },
        "mqtt": {
          "$ref": "#/$defs/mqtt"
        },
        "network": {
          "$ref": "#/$defs/network"
        },
        "topics": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/$defs/topic"
          },
          "default": {
            "topic": "#",
            "qos": 0
          }
        }
      }
    },
    "mqtt": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "client_id": {
          "type": "string",
          "default": ""
        },
        "keep_alive": {
          "type": "integer",
          "default": 60
        },
        "clean_session": {
          "type": "boolean",
          "default": true
        },
        "will_topic": {
          "type": "string",
          "default": ""
        },
        "will_message": {
          "type": "string",
          "default": ""
        },
        "will_qos": {
          "type": "integer",
          "default": 0,
          "minimum": 0,
          "maximum": 2
        },
        "will_retain": {
          "type": "boolean",
          "default": false
        },
        "username": {
          "type": "string",
          "default": ""
        },
        "password": {
          "type": "string",
          "default": ""
        },
        "loop_prevention": {
          "type": "boolean",
          "default": false
        }
      },
      "default": {
        "client_id": "",
        "session_store": "",
        "keep_alive": 60,
        "clean_session": true,
        "will_topic": "",
        "will_message": "",
        "will_qos": 0,
        "will_retain": false,
        "username": "",
        "password": "",
        "loop_prevention": false
      }
    },
    "topic": {
      "type": "object",
      "required": [
        "topic",
        "qos"
      ],
      "additionalProperties": false,
      "properties": {
        "topic": {
          "type": "string",
          "default": "#"
        },
        "qos": {
          "type": "integer",
          "enum": [
            0,
            1,
            2
          ],
          "default": 0
        }
      }
    },
    "network": {
      "type": "object",
      "required": [
        "instance_name",
        "protocol",
        "encryption",
        "transport"
      ],
      "additionalProperties": false,
      "properties": {
        "instance_name": {
          "type": "string"
        },
        "protocol": {
          "type": "string",
          "enum": [
            "in",
            "in6",
            "rc",
            "l2",
            "un"
          ]
        },
        "in": {
          "$ref": "#/$defs/net_in"
        },
        "in6": {
          "$ref": "#/$defs/net_in6"
        },
        "rc": {
          "$ref": "#/$defs/net_rc"
        },
        "l2": {
          "$ref": "#/$defs/net_l2"
        },
        "un": {
          "$ref": "#/$defs/net_un"
        },
        "encryption": {
          "type": "string",
          "enum": [
            "legacy",
            "tls"
          ]
        },
        "transport": {
          "type": "string",
          "enum": [
            "stream",
            "websocket"
          ]
        }
      },
      "oneOf": [
        {
          "properties": {
            "protocol": {
              "const": "in"
            }
          },
          "required": [
            "in"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "in6"
                ]
              },
              {
                "required": [
                  "rc"
                ]
              },
              {
                "required": [
                  "l2"
                ]
              },
              {
                "required": [
                  "un"
                ]
              }
            ]
          },
          "title": "IPv4 Socket"
        },
        {
          "properties": {
            "protocol": {
              "const": "in6"
            }
          },
          "required": [
            "in6"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "in"
                ]
              },
              {
                "required": [
                  "rc"
                ]
              },
              {
                "required": [
                  "l2"
                ]
              },
              {
                "required": [
                  "un"
                ]
              }
            ]
          },
          "title": "IPv6 Socket"
        },
        {
          "properties": {
            "protocol": {
              "const": "rc"
            }
          },
          "required": [
            "rc"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "in"
                ]
              },
              {
                "required": [
                  "in6"
                ]
              },
              {
                "required": [
                  "l2"
                ]
              },
              {
                "required": [
                  "un"
                ]
              }
            ]
          },
          "title": "Bluetooth RFCOMM Socket"
        },
        {
          "properties": {
            "protocol": {
              "const": "l2"
            }
          },
          "required": [
            "l2"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "in"
                ]
              },
              {
                "required": [
                  "in6"
                ]
              },
              {
                "required": [
                  "rc"
                ]
              },
              {
                "required": [
                  "un"
                ]
              }
            ]
          },
          "title": "Bluetooth L2CAP Socket"
        },
        {
          "properties": {
            "protocol": {
              "const": "un"
            }
          },
          "required": [
            "un"
          ],
          "not": {
            "anyOf": [
              {
                "required": [
                  "in"
                ]
              },
              {
                "required": [
                  "in6"
                ]
              },
              {
                "required": [
                  "rc"
                ]
              },
              {
                "required": [
                  "l2"
                ]
              }
            ]
          },
          "title": "Unix Domain Socket"
        }
      ]
    },
    "net_in": {
      "type": "object",
      "required": [
        "host",
        "port"
      ],
      "additionalProperties": false,
      "description": "IPv4 socket (concrete host and port)",
      "properties": {
        "host": {
          "type": "string"
        },
        "port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535
        }
      }
    },
    "net_in6": {
      "type": "object",
      "required": [
        "host",
        "port"
      ],
      "additionalProperties": false,
      "description": "IPv6 socket (concrete host and port)",
      "properties": {
        "host": {
          "type": "string"
        },
        "port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535
        }
      }
    },
    "net_rc": {
      "type": "object",
      "required": [
        "host",
        "channel"
      ],
      "additionalProperties": false,
      "description": "RFCOMM/serial over Bluetooth (concrete address and channel)",
      "properties": {
        "host": {
          "type": "string",
          "pattern": "^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$",
          "examples": [
            "00:1A:7D:DA:71:13"
          ]
        },
        "channel": {
          "type": "integer",
          "minimum": 1,
          "maximum": 30
        }
      }
    },
    "net_l2": {
      "type": "object",
      "required": [
        "host",
        "psm"
      ],
      "additionalProperties": false,
      "description": "L2CAP over Bluetooth (concrete address and psm)",
      "properties": {
        "host": {
          "type": "string",
          "pattern": "^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$",
          "examples": [
            "AA:BB:CC:DD:EE:FF"
          ]
        },
        "psm": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535
        }
      }
    },
    "net_un": {
      "type": "object",
      "required": [
        "path"
      ],
      "additionalProperties": false,
      "description": "Unix domain socket (concrete path)",
      "properties": {
        "path": {
          "type": "string",
          "pattern": "^/(?:[^\\0])+$",
          "maxLength": 107,
          "examples": [
            "/var/run/mqttbridge.sock"
          ]
        }
      }
    }
  }
}
